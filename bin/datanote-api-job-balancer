#!/usr/bin/env node
const program = require('commander')
const main = require('@datagica/datanote-api-job-balancer')

const parseUsers = (val) =>
 val.split(',').map(u => u.split(':'))

program
  .version('0.0.0')
  .option('-d, --debug', 'debug mode', false)
  .option('-t, --timeout [timeout]', 'job timeout', parseInt, 650000)
  .option('-p, --port [port]', 'port [8979]', parseInt, 8979)
  .option('-h, --host [host]', 'host [localhost]', 'localhost')
  .option('-u, --users <users>', 'list of users', parseUsers, [['desktop', 'e85151ee9dd9e95d06067c8d5a2571f2605b9b1c']])
  .option('-m, --maxDomains [maxDomains]', 'max number of domains', parseInt, 1)
  .option('-y, --maxTypes [maxTypes]', 'max number of types', parseInt, 10)
  .parse(process.argv)

// install users
const users = {}
(program.users || []).map(user => {
  users[user[0]] = { [user[1]]: true }
})

main({
  debug: program.debug,
  jobTimeout: program.timeout,
  port: program.port,
  host: program.host,
  apiLimits: {
    maxDomains: program.maxDomains,
    maxTypes: program.maxTypes
  },
  users,
})